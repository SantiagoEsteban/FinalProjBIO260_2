---
title: "Untitled"
author: "Santiago Esteban"
date: "April 28, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Data collection

Our analysis required both, case count data for the 2014 Ebola outbreak in West Africa and also climate data for the same period (2013-2015) and region.

##Case count data
Weekly case counts since the beginning of the outbreak (December 2013) up until November 2015 were obtained from the WHO website on the 2014 Ebola virus outbreak (http://apps.who.int/gho/data/node.ebola-sitrep). Data for Guinea was available per prefecture (34 prefectures; no data for Mandiana). For Sierra Leone and Liberia case counts per district (Sierra Leone, 14 districts) and per county (Liberia, 15 counties) were retrieved. Only cases in the patient database were considered, both confirmed and probable. Probable cases are defined as patients suspected of having Ebola by a physician or deceased patients who died from "suspected" Ebola and had an epidemilogical link to a confirmed Ebola case; A case is classified as "confirmed" if they have a positive PCR-Ebola test.

##Climate data
Information on several climate factors was retrieved from the Climate Research Unit at the University of East Anglia (http://www.cru.uea.ac.uk/). Data for each climate factor was detailed in a grid with a definition of 0.5*0.5 degrees with monthly information. Climate factors include Vapor Pressure (hPa); Mean, Minimum and Maximum Temperature (degrees Celsius); Potential Evapotranspiration (mm per month); Precipitation (mm per month); Wet Day frequency (days per month) and Diurnal Temperature range (degrees Celsius). Data was available up until 2014.
The climate data grid was matched with each of the three countries sub-regions, averaging over the values for the total number of 0.5*0.5 degree squares that fitted into each region.
For the year 2015, no climate data was available, thus it was imputed as the mean of the four previous years. Also, since only monthly information was availble, weekly mean values were interpolated from the monthly data by means of a natural cubic spline function.

Finally information from both sources was combined in long format (LINK TO THE RMD for each country).

#Exploratory data analysis

Incidence 3 countries

```{r}
library(dplyr)
library(readr)
library(lubridate)
library(tidyr)
library(stringr)
library(ggplot2)
library(readxl)
library(ggmap)
library(RNetCDF)
library(xlsx)
library(ggmap)
library(sp)
library(gganimate)
library(ggrepel)
library(gridExtra)
library(RColorBrewer)
library(knitr)

#Loading datasets created in previous step and adding information on the peaks of onset
guinea_weekly_cases_climate <- read.csv('guinea_weekly_cases_climate.csv')
guinea_weekly_cases_climate$Weeks <- dmy(guinea_weekly_cases_climate$Weeks)
guinea_weekly_cases_climate <- group_by(guinea_weekly_cases_climate, Location) %>% mutate(Peak=ifelse(Total_cases>0 & Total_cases==max(Total_cases),1,0), Cum_peak=cumsum(Peak)) %>% ungroup
guinea_weekly_cases_climate$Cum_peak <- ifelse(guinea_weekly_cases_climate$Cum_peak>=1,1,0)


SL_weekly_cases_climate <- read.csv('SL_weekly_cases_climate.csv')
SL_weekly_cases_climate$Weeks <- ymd(SL_weekly_cases_climate$Weeks)
SL_weekly_cases_climate <- group_by(SL_weekly_cases_climate, Location) %>% mutate(Peak=ifelse(Total_cases>0 & Total_cases==max(Total_cases),1,0), Cum_peak=cumsum(Peak)) %>% ungroup
SL_weekly_cases_climate$Cum_peak <- ifelse(SL_weekly_cases_climate$Cum_peak>=1,1,0)

Liberia_weekly_cases_climate <- read.csv('Liberia_weekly_cases_climate.csv')
Liberia_weekly_cases_climate$Weeks <- dmy(Liberia_weekly_cases_climate$Weeks)
Liberia_weekly_cases_climate <- group_by(Liberia_weekly_cases_climate, Location) %>% mutate(Peak=ifelse(Total_cases>0 & Total_cases==max(Total_cases),1,0), Cum_peak=cumsum(Peak)) %>% ungroup
Liberia_weekly_cases_climate$Cum_peak <- ifelse(Liberia_weekly_cases_climate$Cum_peak>=1,1,0)

all_countries <- rbind(guinea_weekly_cases_climate, SL_weekly_cases_climate, Liberia_weekly_cases_climate)

```

First we explore the weekly and cumulative incidence aggregated by country.

```{r}
#Marginal incidence per country
guinea_marginal_incidence <- group_by(guinea_weekly_cases_climate, Weeks) %>% summarise(Total_cases=sum(Total_cases), country='Guinea')
Liberia_marginal_incidence <- group_by(Liberia_weekly_cases_climate, Weeks) %>% summarise(Total_cases=sum(Total_cases), country='Liberia')
SL_marginal_incidence <- group_by(SL_weekly_cases_climate, Weeks) %>% summarise(Total_cases=sum(Total_cases), country='Sierra Leone')
three_countries_marginal_incidence <- rbind(guinea_marginal_incidence, Liberia_marginal_incidence, SL_marginal_incidence)

ggplot() + 
    geom_area(data=filter(guinea_marginal_incidence, Weeks>'2013-12-01'), aes(x=Weeks, y=Total_cases, fill='Guinea'),color='black', alpha=0.5, size=0.5) + 
    geom_area(data=filter(Liberia_marginal_incidence, Weeks>'2013-12-01'), aes(x=Weeks, y=Total_cases, fill='Liberia'),color='black', alpha=0.5, size=0.5) + 
    geom_area(data=filter(SL_marginal_incidence, Weeks>'2013-12-01'), aes(x=Weeks, y=Total_cases, fill='Sierra Leone'), color='black', alpha=0.5, size=0.5) +
    scale_fill_discrete(name='Country') +
    guides(color="none") + ylab('Number of Cases') + ggtitle('Incidence of weekly cases vs Time') +
    theme_classic()

#Cumulative incidence per country
guinea_marginal_cumulative <- group_by(guinea_weekly_cases_climate, Weeks) %>% summarise(Total_cum=sum(Cum_cases), country='Guinea')
Liberia_marginal_cumulative <- group_by(Liberia_weekly_cases_climate, Weeks) %>% summarise(Total_cum=sum(Cum_cases), country='Liberia')
SL_marginal_cumulative <- group_by(SL_weekly_cases_climate, Weeks) %>% summarise(Total_cum=sum(Cum_cases), country='Sierra Leone')
three_countries_marginal_cumulative <- rbind(guinea_marginal_cumulative, Liberia_marginal_cumulative, SL_marginal_cumulative)

kable(group_by(three_countries_marginal_cumulative, country) %>% summarise('Cumulative incidence'=max(Total_cum)))

ggplot() +
    geom_area(data=filter(SL_marginal_cumulative, Weeks>'2013-12-01'), aes(x=Weeks, y=Total_cum, fill='Sierra Leone', color='Sierra Leone'), alpha=0.69, size=1) +
    geom_area(data=filter(Liberia_marginal_cumulative, Weeks>'2013-12-01'), aes(x=Weeks, y=Total_cum, fill='Liberia', color='Liberia'), alpha=0.7, size=1) +
    geom_area(data=filter(guinea_marginal_cumulative, Weeks>'2013-12-01'), aes(x=Weeks, y=Total_cum, fill='Guinea', color='Guinea'), alpha=0.7, size=1) +
    scale_fill_discrete(name='Country') + 
    guides(color = "none")+
    ylab('Cumulative number of cases') +
    ggtitle('Cumulative incidence from 12/2013 - 11/2015') +
    theme_classic()
```

Furthermore, we compare it to the average of the climate factors per country.

```{r}
#Min-Mean-Max temp
guinea_marginal_temp <- group_by(guinea_weekly_cases_climate, Weeks) %>% summarise(tmn=mean(tmn), tmp=mean(tmp), tmx=mean(tmx), country='Guinea')
Liberia_marginal_temp <- group_by(Liberia_weekly_cases_climate, Weeks) %>% summarise(tmn=mean(tmn), tmp=mean(tmp), tmx=mean(tmx), country='Liberia')
SL_marginal_temp <- group_by(SL_weekly_cases_climate, Weeks) %>% summarise(tmn=mean(tmn), tmp=mean(tmp), tmx=mean(tmx), country='Sierra Leone')
three_countries_marginal_climate <- rbind(guinea_marginal_temp, Liberia_marginal_temp, SL_marginal_temp)

#Vapor pressure
guinea_marginal_vap <- group_by(guinea_weekly_cases_climate, Weeks) %>% summarise(vap=mean(vap), country='Guinea')
Liberia_marginal_vap <- group_by(Liberia_weekly_cases_climate, Weeks) %>% summarise(vap=mean(vap), country='Liberia')
SL_marginal_vap <- group_by(SL_weekly_cases_climate, Weeks) %>% summarise(vap=mean(vap), country='Sierra Leone')
three_countries_marginal_climate <- left_join(three_countries_marginal_climate, rbind(guinea_marginal_vap, Liberia_marginal_vap, SL_marginal_vap), by=c('Weeks','country'))

#Precipitation
guinea_marginal_pre <- group_by(guinea_weekly_cases_climate, Weeks) %>% summarise(pre=mean(pre), country='Guinea')
Liberia_marginal_pre <- group_by(Liberia_weekly_cases_climate, Weeks) %>% summarise(pre=mean(pre), country='Liberia')
SL_marginal_pre <- group_by(SL_weekly_cases_climate, Weeks) %>% summarise(pre=mean(pre), country='Sierra Leone')
three_countries_marginal_climate <- left_join(three_countries_marginal_climate, rbind(guinea_marginal_pre, Liberia_marginal_pre, SL_marginal_pre), by=c('Weeks','country'))

#Creating graphs per measurement
three_countries_tmp <- ggplot(data=filter(three_countries_marginal_climate, Weeks>='2013-12-29'), aes(Weeks, tmp)) +
    geom_ribbon(aes(ymin=tmn, ymax=tmx), color='gray', alpha=0.2) + 
    geom_line(aes(y=tmp), color='red', size=0.8) + geom_line(aes(y=tmx), color='orange', size=0.2) +
    geom_line(aes(y=tmn), color='orange', size=0.2) + xlab('') + ylab('Min-Mean-Max\nTemp') + facet_grid(~country) 

three_countries_pre <- ggplot(data=filter(three_countries_marginal_climate, Weeks>='2013-12-29'), aes(Weeks)) + geom_area(aes(y=pre), color='light blue', size=1, fill='light blue', alpha=0.6) +
    geom_line(aes(y=pre), color='light blue')  + xlab('') + ylab('Precipitation\nin mm') + facet_grid(~country)+ theme(strip.background = element_blank(),   strip.text.x = element_blank())

three_countries_vap <- ggplot(data=filter(three_countries_marginal_climate, Weeks>='2013-12-29'), aes(Weeks)) + geom_area(aes(y=vap), size=1, fill='yellow', alpha=0.6) +
    geom_line(aes(y=vap), color='yellow') + xlab('') + ylab('Vapor pressure\nin hPa') + facet_grid(~country)+ theme(strip.background = element_blank(),   strip.text.x = element_blank())

three_countries_incidence <- ggplot(data=filter(three_countries_marginal_incidence, Weeks>='2013-12-29'), aes(Weeks)) + geom_area(aes(y=Total_cases), size=1, fill='light green', alpha=0.6) +
    geom_line(aes(y=Total_cases), color='light green') + xlab('') + ylab('Case count') + facet_grid(~country)+ theme(strip.background = element_blank(),   strip.text.x = element_blank())

three_countries_cumulative <- ggplot(data=filter(three_countries_marginal_cumulative, Weeks>='2013-12-29'), aes(Weeks)) + geom_area(aes(y=Total_cum), size=1, fill='orange', alpha=0.6) +
    geom_line(aes(y=Total_cum), color='orange') + xlab('') + ylab('Cumualtive case count') + facet_grid(~country)+ theme(strip.background = element_blank(),   strip.text.x = element_blank())

grid.arrange(three_countries_tmp, three_countries_pre, three_countries_vap, three_countries_incidence, three_countries_cumulative, nrow=5)
```

We can see that temperature has a downward trajectory in the weeks preceding the onset of the outbreak in all three countries. This is particularly the case for maximum temperature. It also coincides with the start of the rainy season. 


We visualize now the cumulative incidence per region for the three countries at the end of 2015 to see which were the most affected districts.


```{r}
#Creating dataframe with maps, climate and case count data.

#########
#Map data
#########

#Guinea
guineards <- readRDS("D:/Google Drive/Medicina/MPH/Courses/BIO 260/FinalProjBIO260_2/Guinea-Admin/GIN_adm2.rds")
guineashp.df <- fortify(guineards)
guinea_map <- as.data.frame(cbind(NAME_2=guineards@data$NAME_2, id=guineards@data$ID_2))
guinea_map$NAME_2 <- toupper(guinea_map$NAME_2)
guinea_map$NAME_2 <- str_replace_all(guinea_map$NAME_2, "BOKÉ", "BOKE")
guinea_map$NAME_2 <- str_replace_all(guinea_map$NAME_2, "DINGUIRAYE", "DINGUIRAY")
guinea_map$NAME_2 <- str_replace_all(guinea_map$NAME_2, "KÉROUANÉ", "KEROUANE")
guinea_map$NAME_2 <- str_replace_all(guinea_map$NAME_2, "DUBRÉKA", "DUBREKA")
guinea_map$NAME_2 <- str_replace_all(guinea_map$NAME_2, "FORÉCARIAH", "FORECARIAH")
guinea_map$NAME_2 <- str_replace_all(guinea_map$NAME_2, "TÉLIMÉLÉ", "TELIMELE")
guinea_map$NAME_2 <- str_replace_all(guinea_map$NAME_2, "LÉLOUMA", "LELOUMA")
guinea_map$NAME_2 <- str_replace_all(guinea_map$NAME_2, "LABÉ", "LABE")
guinea_map$NAME_2 <- str_replace_all(guinea_map$NAME_2, "TOUGUÉ", "TOUGUE")
guinea_map$NAME_2 <- str_replace_all(guinea_map$NAME_2, "GUÉCKÉDOU", "GUECKEDOU")
guinea_map$NAME_2 <- str_replace_all(guinea_map$NAME_2, "NZÉRÉKORÉ", "NZEREKORE")
guinea_map$NAME_2 <- str_replace_all(guinea_map$NAME_2, "YAMOU", "YOMOU")
guinea_map <- left_join(guineashp.df, guinea_map, by='id')
guinea_map <- rename(guinea_map, Location=NAME_2)
guinea_map_complete <- left_join(guinea_weekly_cases_climate, guinea_map, by='Location')
guineards_adm0 <- readRDS("D:/Google Drive/Medicina/MPH/Courses/BIO 260/FinalProjBIO260_2/Guinea-Admin/GIN_adm0.rds")
guineashp.adm0 <- fortify(guineards_adm0)

#Sierra Leone
SLrds <- readRDS("D:/Google Drive/Medicina/MPH/Courses/BIO 260/FinalProjBIO260_2/Guinea-Admin/SLE_adm2.rds")
SLshp.df <- fortify(SLrds)
SL_map <- as.data.frame(cbind(NAME_2=SLrds@data$NAME_2, id=SLrds@data$ID_2))
SL_map$NAME_2 <-str_replace(SL_map$NAME_2, "Western Urban", "WESTERNURBAN")
SL_map$NAME_2 <-str_replace(SL_map$NAME_2, "Western Rural", "WESTERNRURAL")
SL_map$NAME_2 <-str_replace(SL_map$NAME_2, "Port Loko", "PORTLOKO")
SL_map$NAME_2 <- toupper(SL_map$NAME_2)
SL_map <- left_join(SLshp.df, SL_map, by='id')
SL_map <- rename(SL_map, Location=NAME_2)
SL_map_complete <- left_join(SL_weekly_cases_climate, SL_map, by='Location')
SL_adm0_rds <- readRDS("D:/Google Drive/Medicina/MPH/Courses/BIO 260/FinalProjBIO260_2/Guinea-Admin/SLE_adm0.rds")
SLshp.adm0 <- fortify(SL_adm0_rds)
SL_map_complete$group <- as.factor(as.numeric(as.character(SL_map_complete$group))+100)

#Liberia
LBrds <- readRDS("D:/Google Drive/Medicina/MPH/Courses/BIO 260/FinalProjBIO260_2/Guinea-Admin/LBR_adm1.rds")
LBshp.df <- fortify(LBrds)
LB_map <- as.data.frame(cbind(Location=LBrds@data$NAME_1, id=LBrds@data$ID_1))
LB_map$Location <- toupper(LB_map$Location)
LB_map$Location <-str_replace(LB_map$Location, "GBAPOLU", "GBARPOLU")
LB_map$Location <-str_replace(LB_map$Location, "GRANDBASSA", "GRAND_BASSA")
LB_map$Location <-str_replace(LB_map$Location, "GRANDGEDEH", "GRAND_GEDEH")
LB_map$Location <-str_replace(LB_map$Location, "GRANDKRU", "GRAND_KRU")
LB_map$Location <-str_replace(LB_map$Location, "RIVER CESS", "RIVER_CESS")
LB_map$Location <-str_replace(LB_map$Location, "GRAND CAPE MOUNT", "GRAND_CAPE_MOUNT")
LB_map$Location <-str_replace(LB_map$Location, "RIVER GEE", "RIVER_GEE")
LB_map <- left_join(LBshp.df, LB_map, by='id')
LB_map_complete <- left_join(Liberia_weekly_cases_climate, LB_map, by='Location')
LB_adm0_rds <- readRDS("D:/Google Drive/Medicina/MPH/Courses/BIO 260/FinalProjBIO260_2/Guinea-Admin/LBR_adm0.rds")
LBshp.adm0 <- fortify(LB_adm0_rds)
LB_map_complete$group <- as.factor(as.numeric(as.character(LB_map_complete$group))+200)
```

##Cumulative incidence per region

We can clearly see that the highest number of cases were concentrated near the capitals of the three countries: Conakry (Conakry, Guinea), Freetown (Western Urban, Sierra Leone) and Monrovia (Montserrado, Liberia), while other districts presented no cases.

```{r}
cumulative_guinea_district <- group_by(guinea_weekly_cases_climate, Location) %>%
    summarise('Cumulative incidence'=max(Cum_cases))
cumulative_Liberia_district <- group_by(Liberia_weekly_cases_climate, Location) %>%
    summarise('Cumulative incidence'=max(Cum_cases))
cumulative_SL_district <- group_by(SL_weekly_cases_climate, Location) %>%
    summarise('Cumulative incidence'=max(Cum_cases))

kable(cumulative_guinea_district, format="html", caption='Cumulative incidence by district for Guinea, 12/2013 - 11/2015')
kable(cumulative_Liberia_district, format="html", caption='Cumulative incidence by district for Liberia, 12/2013 - 11/2015')
kable(cumulative_SL_district, format="html", caption='Cumulative incidence by district for Sierra Leone, 12/2013 - 11/2015')

#Maps showing cumulative incidence by district
mypalette<-brewer.pal(9,"Oranges")
 ggplot() +
    geom_polygon(data=filter(guinea_map_complete,count_week==152), aes(x = long, y = lat, group = group, fill = Cum_cases), color="black", size=0.25) + scale_fill_gradientn(name='Cumulative cases', colours = mypalette, values=c(0,0.05,0.1,0.2,0.3, 0.4, 0.5, 1)) +
geom_polygon(data=filter(SL_map_complete,count_week==152), aes(x = long, y = lat, group = group, fill = Cum_cases), color="black", size=0.25) +
    geom_polygon(data=filter(LB_map_complete,count_week==152), aes(x = long, y = lat, group = group, fill = Cum_cases), color="black", size=0.25)  +
    geom_polygon(aes(x = long, y = lat, group = group, color="Guinea"), fill=NA, size = 0.75, data=guineashp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Sierra Leone"), fill=NA, size = 0.75, data=SLshp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Liberia"), fill=NA, size = 0.75, data=LBshp.adm0) +
    geom_point(aes(x=-13.628, y=9.5876), color='blue', size=3) +
    geom_point(aes(x=-13.2317, y=8.4657), color='blue', size=3) +
    geom_point(aes(x=-10.7605, y=6.2907), color='blue', size=3) +
    geom_text(aes(x=-14.1784, y=9.6412, label='Conakry'), size=5) +
    geom_text(aes(x=-13.8317, y=8.4657, label='Freetown'), size=5) +
    geom_text(aes(x=-11.3605, y=6.2907, label='Monrovia'), size=5) +
    coord_map() + scale_color_discrete(name="Country") + theme_classic() +
        ggtitle('Cumulative case count by November 2015')
```

Nevertheless, as we can see in the animation below, the outbreak began near the junction of the three borders and later expanded towards the main cities.

```{r}
three_countries_map_complete <- rbind(
    select(guinea_map_complete, count_week, Location, long, lat, group, Cum_cases, Total_cases, Peak, Cum_peak,Weeks, Country) %>% filter(Weeks>'2013-12-01'),
    select(SL_map_complete, Location, count_week, long, lat, group, Cum_cases, Total_cases, Peak, Cum_peak, Weeks,Country) %>% filter(Weeks>'2013-12-01'),
    select(LB_map_complete, Location, count_week, long, lat, group, Cum_cases, Total_cases, Peak, Cum_peak, Weeks, Country) %>% filter(Weeks>'2013-12-01')
)

weeks_incidence <- seq(53,152, by=4)
three_countries_map_incidence <- ggplot(filter(three_countries_map_complete, count_week%in%weeks_incidence), aes(x = long, y = lat, group = group, fill = Cum_cases, frame=Weeks)) +
    geom_polygon(color = "black", size = 0.25) + coord_map() + scale_fill_gradientn(name='Cumulative case count', colours = mypalette, values=c(0,0.05,0.1,0.2,0.3, 0.4, 0.5, 1))

gg_animate(three_countries_map_incidence)

```

#Analysis per main district

As we did beforfe we explore the relationship between climate factors and incidence, but this time by main district. Again, we see the same pattern as described at the country level: temperature drops and the peak of the rainy season is reached weeks before the onset of the outbreak.

```{r}
loc <- c('CONAKRY', 'WESTERNURBAN','MONTSERRADO')
three_cities <-filter(all_countries, Location%in%loc, Weeks>='2013-12-29')

three_cities_tmp <- ggplot(three_cities, aes(Weeks, tmp)) +
    geom_ribbon(aes(ymin=tmn, ymax=tmx), color='gray', alpha=0.2) + 
    geom_line(aes(y=tmp), color='red', size=0.8) + geom_line(aes(y=tmx), color='orange', size=0.2) +
    geom_line(aes(y=tmn), color='orange', size=0.2) + xlab('') + ylab('Min-Mean-Max\nTemp') + facet_grid(~Location) 

three_cities_pre <- ggplot(three_cities, aes(Weeks)) + geom_area(aes(y=pre), color='light blue', size=1, fill='light blue', alpha=0.6) +
    geom_line(aes(y=pre), color='light blue')  + xlab('') + ylab('Precipitation\nin mm') + facet_grid(~Location)+ theme(strip.background = element_blank(),   strip.text.x = element_blank())

three_cities_vap <- ggplot(three_cities, aes(Weeks)) + geom_area(aes(y=vap), size=1, fill='yellow', alpha=0.6) +
    geom_line(aes(y=vap), color='yellow') + xlab('') + ylab('Vapor pressure\nin hPa') + facet_grid(~Location)+ theme(strip.background = element_blank(),   strip.text.x = element_blank())

three_cities_total <- ggplot(three_cities, aes(Weeks)) + geom_area(aes(y=Total_cases), size=1, fill='light green', alpha=0.6) +
    geom_line(aes(y=Total_cases), color='light green') + xlab('') + ylab('Case count') + facet_grid(~Location)+ theme(strip.background = element_blank(),   strip.text.x = element_blank())

three_cities_cum <- ggplot(three_cities, aes(Weeks)) + geom_area(aes(y=Cum_cases), size=1, fill='orange', alpha=0.6) +
    geom_line(aes(y=Cum_cases), color='orange') + xlab('') + ylab('Cumualtive case count') + facet_grid(~Location)+ theme(strip.background = element_blank(),   strip.text.x = element_blank())

grid.arrange(three_cities_tmp, three_cities_pre, three_cities_vap, three_cities_total, three_cities_cum, nrow=5)
```


#Analysis per district

We saw before that not all districts were affected. Thus we explore the relationship between the climatic factors and the incidence on all regions. In the figure below we can appreciate how incidence increases as the temperature drops and the dry season begins.

```{r}
three_countries_map_climate <- rbind(
    select(guinea_map_complete, Location, count_week, long, lat, group, tmp, tmx, tmn, pre, vap, Total_cases, Weeks, Country) %>% filter(Weeks>'2013-12-01'),
    select(SL_map_complete, Location, count_week, long, lat, group, tmp, tmx, tmn, pre, vap, Total_cases, Weeks,Country) %>% filter(Weeks>'2013-12-01'),
    select(LB_map_complete, Location, count_week, long, lat, group, tmp, tmx, tmn, pre, vap,Total_cases, Weeks, Country) %>% filter(Weeks>'2013-12-01'))

#Mean Temp
tmp.palette <- brewer.pal(5,name="Oranges")
tmp <- ggplot(three_countries_map_climate %>% 
           filter(count_week==77 | count_week==89 | count_week==101|count_week==113)
       , aes(x = long, y = lat, group = group, fill = tmp)) +
    geom_polygon(color = "black", size = 0.25) + scale_fill_gradientn(colors=tmp.palette, name='') +
    geom_polygon(aes(x = long, y = lat, group = group, color="Guinea"), fill=NA, size = 0.75, data=guineashp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Sierra Leone"), fill=NA, size = 0.75, data=SLshp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Liberia"), fill=NA, size = 0.75, data=LBshp.adm0) +
    coord_map() + guides(color='none')+ facet_grid(Weeks~.) + theme(strip.background = element_blank(),   strip.text.x = element_blank(), strip.text.y = element_blank(), legend.position='bottom') +
    ggtitle('Mean Temp.')

#Max Temp
tmx.palette <- brewer.pal(5,name='Reds')
tmx <- ggplot(three_countries_map_climate %>% 
           filter(count_week==77 | count_week==89 | count_week==101|count_week==113)
       , aes(x = long, y = lat, group = group, fill = tmx)) +
    geom_polygon(color = "black", size = 0.25) + scale_fill_gradientn(colors=tmx.palette, name='') +
    geom_polygon(aes(x = long, y = lat, group = group, color="Guinea"), fill=NA, size = 0.75, data=guineashp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Sierra Leone"), fill=NA, size = 0.75, data=SLshp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Liberia"), fill=NA, size = 0.75, data=LBshp.adm0) +
    coord_map() + guides(color='none')+ 
    facet_grid(Weeks~.) + 
    theme(strip.background = element_blank(),   strip.text.x = element_blank(), strip.text.y = element_blank(), legend.position='bottom') +
    ggtitle('Max Temp.')

#Min Temp
tmn.palette <- brewer.pal(5, name='Purples')
tmn <- ggplot(three_countries_map_climate %>% 
           filter(count_week==77 | count_week==89 | count_week==101|count_week==113)
       , aes(x = long, y = lat, group = group, fill = tmn)) +
    geom_polygon(color = "black", size = 0.25) + scale_fill_gradientn(colors=tmn.palette, name='') +
    geom_polygon(aes(x = long, y = lat, group = group, color="Guinea"), fill=NA, size = 0.75, data=guineashp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Sierra Leone"), fill=NA, size = 0.75, data=SLshp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Liberia"), fill=NA, size = 0.75, data=LBshp.adm0) +
    coord_map() + guides(color='none')+ 
    facet_grid(Weeks~.) + 
    theme(strip.background = element_blank(),   strip.text.x = element_blank(), strip.text.y = element_blank(), legend.position='bottom') +
    ggtitle('Min Temp.')

#Precipitation
pre.palette <- brewer.pal(5, name='Blues')
pre <- ggplot(three_countries_map_climate %>% 
           filter(count_week==77 | count_week==89 | count_week==101|count_week==113)
       , aes(x = long, y = lat, group = group, fill = pre)) +
    geom_polygon(color = "black", size = 0.25) + scale_fill_gradientn(colors=pre.palette, name='') +
    geom_polygon(aes(x = long, y = lat, group = group, color="Guinea"), fill=NA, size = 0.75, data=guineashp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Sierra Leone"), fill=NA, size = 0.75, data=SLshp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Liberia"), fill=NA, size = 0.75, data=LBshp.adm0) +
    coord_map() + guides(color='none')+ facet_grid(Weeks~.) + theme(strip.background = element_blank(),   strip.text.x = element_blank(), strip.text.y = element_blank(), legend.position='bottom') +
    ggtitle('Precipitation\nin mm')

#Vapor pressure
vap.palette <- brewer.pal(5, name='BuGn')
vap <- ggplot(three_countries_map_climate %>% 
           filter(count_week==77 | count_week==89 | count_week==101|count_week==113)
       , aes(x = long, y = lat, group = group, fill = vap)) +
    geom_polygon(color = "black", size = 0.25) + scale_fill_gradientn(colors=vap.palette, name='') +
    geom_polygon(aes(x = long, y = lat, group = group, color="Guinea"), fill=NA, size = 0.75, data=guineashp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Sierra Leone"), fill=NA, size = 0.75, data=SLshp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Liberia"), fill=NA, size = 0.75, data=LBshp.adm0) +
    coord_map() + guides(color='none')+ facet_grid(Weeks~.) + theme(strip.background = element_blank(),   strip.text.x = element_blank(), strip.text.y = element_blank(), legend.position='bottom') +
    ggtitle('Vapor pressure\nin hPa')

#Incidence
cases <- ggplot(three_countries_map_climate %>% 
           filter(count_week==77 | count_week==89 | count_week==101|count_week==113)
       , aes(x = long, y = lat, group = group, fill = Total_cases)) +
    geom_polygon(color = "black",  size = 0.25) + scale_fill_gradientn(colors=terrain.colors(10), values=c(0,0.05,0.1,0.15,0.25,0.3,1), name='') +
    geom_polygon(aes(x = long, y = lat, group = group, color="Guinea"), fill=NA, size = 0.75, data=guineashp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Sierra Leone"), fill=NA, size = 0.75, data=SLshp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Liberia"), fill=NA, size = 0.75, data=LBshp.adm0) +
    coord_map() + guides(color='none') + facet_grid(Weeks~.) +
    theme(legend.position='bottom') +
    ggtitle('Weekly incidence')

grid.arrange(tmp, tmx, tmn, pre, vap, cases, ncol=6)
```


We can also see that the incidence is also associated with the difference in temperature and precipitation over four weeks, as shown in the maps below.

```{r}
load("guinea_climate_dif.Rdata")
load("SL_climate_dif.Rdata")
load("Liberia_climate_dif.Rdata")

guinea_climate_dif <- left_join(guinea_climate_dif, guinea_map, by='Location')
guinea_climate_dif$tmp_dif <- as.numeric(as.character(guinea_climate_dif$tmp_dif))
guinea_climate_dif$tmn_dif <- as.numeric(as.character(guinea_climate_dif$tmn_dif))
guinea_climate_dif$tmx_dif <- as.numeric(as.character(guinea_climate_dif$tmx_dif))
guinea_climate_dif$pre_dif <- as.numeric(as.character(guinea_climate_dif$pre_dif))
guinea_climate_dif$vap_dif <- as.numeric(as.character(guinea_climate_dif$vap_dif))

SL_climate_dif <- left_join(SL_climate_dif, SL_map, by='Location')
SL_climate_dif$group <- as.factor(as.numeric(as.character(SL_climate_dif$group))+100)
SL_climate_dif$tmp_dif <- as.numeric(as.character(SL_climate_dif$tmp_dif))
SL_climate_dif$tmn_dif <- as.numeric(as.character(SL_climate_dif$tmn_dif))
SL_climate_dif$tmx_dif <- as.numeric(as.character(SL_climate_dif$tmx_dif))
SL_climate_dif$pre_dif <- as.numeric(as.character(SL_climate_dif$pre_dif))
SL_climate_dif$vap_dif <- as.numeric(as.character(SL_climate_dif$vap_dif))

Liberia_climate_dif <- left_join(Liberia_climate_dif, LB_map, by='Location')
Liberia_climate_dif$group <- as.factor(as.numeric(as.character(Liberia_climate_dif$group))+200)
Liberia_climate_dif$tmp_dif <- as.numeric(as.character(Liberia_climate_dif$tmp_dif))
Liberia_climate_dif$tmn_dif <- as.numeric(as.character(Liberia_climate_dif$tmn_dif))
Liberia_climate_dif$tmx_dif <- as.numeric(as.character(Liberia_climate_dif$tmx_dif))
Liberia_climate_dif$pre_dif <- as.numeric(as.character(Liberia_climate_dif$pre_dif))
Liberia_climate_dif$vap_dif <- as.numeric(as.character(Liberia_climate_dif$vap_dif))

three_countries_climate_dif <- rbind(guinea_climate_dif, SL_climate_dif, Liberia_climate_dif)

#Creating maps
tmp.palette <- brewer.pal(5,name="Oranges")
tmp_dif <- ggplot(three_countries_climate_dif %>% 
           filter(count_week==77 | count_week==89 | count_week==101|count_week==113)
       , aes(x = long, y = lat, group = group, fill = tmp_dif)) +
    geom_polygon(color = "black", size = 0.25) + scale_fill_gradientn(colors=tmp.palette, name='') +
    geom_polygon(aes(x = long, y = lat, group = group, color="Guinea"), fill=NA, size = 0.75, data=guineashp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Sierra Leone"), fill=NA, size = 0.75, data=SLshp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Liberia"), fill=NA, size = 0.75, data=LBshp.adm0) +
    coord_map() + guides(color='none')+ facet_grid(Weeks~.) + theme(strip.background = element_blank(),   strip.text.x = element_blank(), strip.text.y = element_blank(), legend.position='bottom') +
    ggtitle('Mean Temp. dif')

#Max Temp
tmx.palette <- brewer.pal(5,name='Reds')
tmx_dif <- ggplot(three_countries_climate_dif %>% 
           filter(count_week==77 | count_week==89 | count_week==101|count_week==113)
       , aes(x = long, y = lat, group = group, fill = tmx_dif)) +
    geom_polygon(color = "black", size = 0.25) + scale_fill_gradientn(colors=tmx.palette, name='') +
    geom_polygon(aes(x = long, y = lat, group = group, color="Guinea"), fill=NA, size = 0.75, data=guineashp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Sierra Leone"), fill=NA, size = 0.75, data=SLshp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Liberia"), fill=NA, size = 0.75, data=LBshp.adm0) +
    coord_map() + guides(color='none')+ 
    facet_grid(Weeks~.) + 
    theme(strip.background = element_blank(),   strip.text.x = element_blank(), strip.text.y = element_blank(), legend.position='bottom') +
    ggtitle('Max Temp. dif')

#Min Temp
tmn.palette <- brewer.pal(5, name='Purples')
tmn_dif <- ggplot(three_countries_climate_dif %>% 
           filter(count_week==77 | count_week==89 | count_week==101|count_week==113)
       , aes(x = long, y = lat, group = group, fill = tmn_dif)) +
    geom_polygon(color = "black", size = 0.25) + scale_fill_gradientn(colors=tmn.palette, name='') +
    geom_polygon(aes(x = long, y = lat, group = group, color="Guinea"), fill=NA, size = 0.75, data=guineashp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Sierra Leone"), fill=NA, size = 0.75, data=SLshp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Liberia"), fill=NA, size = 0.75, data=LBshp.adm0) +
    coord_map() + guides(color='none')+ 
    facet_grid(Weeks~.) + 
    theme(strip.background = element_blank(),   strip.text.x = element_blank(), strip.text.y = element_blank(), legend.position='bottom') +
    ggtitle('Min Temp. dif')

#Precipitation
pre.palette <- brewer.pal(5, name='Blues')
pre_dif <- ggplot(three_countries_climate_dif %>% 
           filter(count_week==77 | count_week==89 | count_week==101|count_week==113)
       , aes(x = long, y = lat, group = group, fill = pre_dif)) +
    geom_polygon(color = "black", size = 0.25) + scale_fill_gradientn(colors=pre.palette, name='') +
    geom_polygon(aes(x = long, y = lat, group = group, color="Guinea"), fill=NA, size = 0.75, data=guineashp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Sierra Leone"), fill=NA, size = 0.75, data=SLshp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Liberia"), fill=NA, size = 0.75, data=LBshp.adm0) +
    coord_map() + guides(color='none')+ facet_grid(Weeks~.) + theme(strip.background = element_blank(),   strip.text.x = element_blank(), strip.text.y = element_blank(), legend.position='bottom') +
    ggtitle('Precipitation\ndif')

#Vapor pressure
vap.palette <- brewer.pal(5, name='BuGn')
vap_dif <- ggplot(three_countries_climate_dif %>% 
           filter(count_week==77 | count_week==89 | count_week==101|count_week==113)
       , aes(x = long, y = lat, group = group, fill = vap_dif)) +
    geom_polygon(color = "black", size = 0.25) + scale_fill_gradientn(colors=vap.palette, name='') +
    geom_polygon(aes(x = long, y = lat, group = group, color="Guinea"), fill=NA, size = 0.75, data=guineashp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Sierra Leone"), fill=NA, size = 0.75, data=SLshp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Liberia"), fill=NA, size = 0.75, data=LBshp.adm0) +
    coord_map() + guides(color='none')+ facet_grid(Weeks~.) + theme(strip.background = element_blank(),   strip.text.x = element_blank(), strip.text.y = element_blank(), legend.position='bottom') +
    ggtitle('Vapor pressure\ndif')

#Incidence
cases <- ggplot(three_countries_climate_dif %>% 
           filter(count_week==77 | count_week==89 | count_week==101|count_week==113)
       , aes(x = long, y = lat, group = group, fill = Total_cases)) +
    geom_polygon(color = "black",  size = 0.25) + scale_fill_gradientn(colors=terrain.colors(10), values=c(0,0.05,0.1,0.15,0.25,0.3,1), name='') +
    geom_polygon(aes(x = long, y = lat, group = group, color="Guinea"), fill=NA, size = 0.75, data=guineashp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Sierra Leone"), fill=NA, size = 0.75, data=SLshp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Liberia"), fill=NA, size = 0.75, data=LBshp.adm0) +
    coord_map() + guides(color='none') + facet_grid(Weeks~.) +
    theme(legend.position='bottom') +
    ggtitle('Weekly incidence')

grid.arrange(tmp_dif, tmx_dif, tmn_dif, pre_dif, vap_dif, cases, ncol=6)


```


##Peaks

```{r}
three_countries_peaks <- all_countries %>% select(Location, count_week, Total_cases, Weeks, Peak, Country)
ggplot(data=filter(all_countries, Peak==1 & Cum_peak==1), aes(x=Weeks, y=Total_cases)) +
    geom_point() +
    geom_line(aes(color=Country)) +
    #geom_text_repel(aes(label=Location)) +
    facet_grid(Country~.)


weeks_count <- c(60,70,80,85,90,95,100,105,110,115, 120,150)
ggplot(data=filter(three_countries_map_complete, count_week%in%weeks_count), aes(x = long, y = lat, group = group, fill=Cum_peak)) +
    geom_polygon(color = "black", size = 0.25) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Guinea"), fill=NA, size = 0.75, data=guineashp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Sierra Leone"), fill=NA, size = 0.75, data=SLshp.adm0) +
    geom_polygon(aes(x = long, y = lat, group = group, color="Liberia"), fill=NA, size = 0.75, data=LBshp.adm0) +
        scale_color_discrete(name='Country') +
    scale_fill_continuous(low='gray', high='dark red') +
    guides(fill='none') +
    coord_map() +facet_wrap(~Weeks, ncol=4)


```


MONTHLY data in the other rmd

